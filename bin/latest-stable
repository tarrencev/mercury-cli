#!/usr/bin/env bash
set -euo pipefail
[ "${BASH_VERSINFO[0]:-0}" -ge 3 ] && set -o pipefail

fail() {
  echo "asdf-mercury-cli: $*" >&2
  exit 1
}

need() {
  command -v "$1" >/dev/null 2>&1 || fail "missing required command: $1"
}

need curl

plugin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
prefix="${1:-}"

repo="${ASDF_PLUGIN_SOURCE_URL:-https://github.com/tarrencev/mercury-cli.git}"
repo="${repo%.git}"

os="$(uname -s | tr '[:upper:]' '[:lower:]')"
case "$os" in
  linux*) os="linux" ;;
  darwin*) os="darwin" ;;
  msys*|mingw*|cygwin*) os="windows" ;;
  *) fail "unsupported OS: $os" ;;
esac

arch="$(uname -m)"
case "$arch" in
  x86_64|amd64) arch="amd64" ;;
  aarch64|arm64) arch="arm64" ;;
  *) fail "unsupported architecture: $arch" ;;
esac

ext="tar.gz"
if [ "$os" = "windows" ]; then
  ext="zip"
fi

# Prefer stable versions (no prerelease suffix).
mapfile -t versions < <("$plugin_dir/bin/list-all" \
  | tr ' ' '\n' \
  | sed 's/^[[:space:]]\+//' \
  | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
  | { sort -V 2>/dev/null || sort; })

if [ -n "$prefix" ]; then
  mapfile -t versions < <(printf "%s\n" "${versions[@]}" | grep -E "^${prefix}")
fi

for ((i=${#versions[@]}-1; i>=0; i--)); do
  version="${versions[i]}"
  tag="v${version}"
  name="mercury_${version}_${os}_${arch}.${ext}"
  url="${repo}/releases/download/${tag}/${name}"

  # Follow redirects: GitHub releases redirect to storage.
  http_code="$(curl -sSLI -o /dev/null -w '%{http_code}' "$url" || true)"
  if [ "$http_code" != "404" ] && [ "$http_code" != "403" ] && [ "$http_code" != "000" ]; then
    printf "%s" "$version"
    exit 0
  fi
done

exit 1
